<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="FAL分区管理与easyflash变量管理"><title>【NXP】LPC55S69_FAL分区管理与easyflash变量管理</title>
<link rel=canonical href=https://kurisaw.github.io/p/nxplpc55s69_fal%E5%88%86%E5%8C%BA%E7%AE%A1%E7%90%86%E4%B8%8Eeasyflash%E5%8F%98%E9%87%8F%E7%AE%A1%E7%90%86/><link rel=stylesheet href=/scss/style.min.0304c6baf04e01a8fe70693791cb744d56a3578a3120a8796cefc66825aa39c7.css><meta property='og:title' content="【NXP】LPC55S69_FAL分区管理与easyflash变量管理"><meta property='og:description' content="FAL分区管理与easyflash变量管理"><meta property='og:url' content='https://kurisaw.github.io/p/nxplpc55s69_fal%E5%88%86%E5%8C%BA%E7%AE%A1%E7%90%86%E4%B8%8Eeasyflash%E5%8F%98%E9%87%8F%E7%AE%A1%E7%90%86/'><meta property='og:site_name' content='kurisaW'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='NXP'><meta property='article:tag' content='LPC55s69'><meta property='article:tag' content='LPC'><meta property='article:tag' content='FAL'><meta property='article:tag' content='SFUD'><meta property='article:tag' content='Easyflash'><meta property='article:published_time' content='2023-04-23T00:00:00+00:00'><meta property='article:modified_time' content='2023-04-23T00:00:00+00:00'><meta property='og:image' content='https://kurisaw.github.io/p/nxplpc55s69_fal%E5%88%86%E5%8C%BA%E7%AE%A1%E7%90%86%E4%B8%8Eeasyflash%E5%8F%98%E9%87%8F%E7%AE%A1%E7%90%86/cover.jpg'><meta name=twitter:title content="【NXP】LPC55S69_FAL分区管理与easyflash变量管理"><meta name=twitter:description content="FAL分区管理与easyflash变量管理"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://kurisaw.github.io/p/nxplpc55s69_fal%E5%88%86%E5%8C%BA%E7%AE%A1%E7%90%86%E4%B8%8Eeasyflash%E5%8F%98%E9%87%8F%E7%AE%A1%E7%90%86/cover.jpg'></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=https://raw.githubusercontent.com/kurisaW/kurisaW.github.io/master/assets/figures/head_figure.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🍥</span></figure><div class=site-meta><h1 class=site-name><a href=/>kurisaW</a></h1><h2 class=site-description>Tomorrow is gone！</h2></div></header><ol class=menu-social><li><a href=https://chat-gpt-next-web-kurisaw.vercel.app/ target=_blank title=chatbot rel=me><!doctype html><svg t="1679145076106" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="2362" width="100" height="100" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M956.488825 419.108638a252.269534 252.269534.0 00-22.198841-209.554136A262.216956 262.216956.0 00707.547289 80.018594c-18.468558.0-36.863974 1.938284-54.893675 5.74171A260.095814 260.095814.0 00459.264038 366e-6h-2.230856c-113.407919.0-213.942704 72.191948-248.831822 178.651301A258.41353 258.41353.0 0035.32834 302.409293 255.56096 255.56096.0 00366e-6 431.872057c0 63.963383 24.063983 125.622767 67.510809 173.055877a252.15982 252.15982.0 0022.198841 209.480993c56.612531 97.279931 170.422735 147.34618 281.599799 123.830769A260.132386 260.132386.0 00564.699391 1023.999634h2.303998c113.481062.0 214.015847-72.191948 248.868394-178.724443a258.450101 258.450101.0 00172.836448-123.757626 255.231818 255.231818.0 00-32.182834-302.445499zM566.418247 957.073968h-.256a195.693575 195.693575.0 01-124.233054-44.434254c2.047999-1.097142 4.095997-2.230856 6.107424-3.437712l206.628424-117.759916a33.097119 33.097119.0 0017.005702-28.818265v-287.63408l87.332509 49.737107a3.071998 3.071998.0 011.718856 2.377141v238.07983c-.109714 105.801067-87.039938 191.634149-194.303861 191.853577zM148.553402 780.909522a189.513007 189.513007.0 01-23.22284-128.585051l6.143996 3.65714 206.628423 117.759916a34.047976 34.047976.0 0033.974833.0l252.269534-143.725611v99.657071a3.071998 3.071998.0 01-1.243427 2.486856L414.20807 851.163186c-29.549693 16.786274-63.049098 25.599982-97.170216 25.599982-69.485665.0-133.668476-36.534831-168.484452-95.817074zM94.171727 335.872126a193.206719 193.206719.0 01101.266213-84.150797l-.109714 7.021709v235.73926c0 11.922277 6.473138 22.893698 16.969131 28.781694l252.269534 143.725612-87.332509 49.737107a3.181712 3.181712.0 01-2.925712.292571L165.376248 597.906224A191.67072 191.67072.0 0168.242603 431.652629c0-33.609119 8.959994-66.633095 25.965695-95.817075zm717.604059 164.754168L559.542823 356.900682l87.332509-49.737107a3.145141 3.145141.0 012.925712-.292571l208.932423 119.003343a191.561006 191.561006.0 0197.243359 166.217024c0 80.383943-50.834249 152.356463-127.305052 180.114157V529.627416v-.292571a33.060548 33.060548.0 00-16.822845-28.708551zm86.930223-129.097051a297.691216 297.691216.0 00-6.143995-3.620569L685.93359 250.148758a34.084547 34.084547.0 00-33.938261.0L399.689223 393.87437V294.180727c0-.987428.475428-1.901713 1.279999-2.486855l208.895851-118.857058a196.571288 196.571288.0 0197.133645-25.673125c107.410209.0 194.52329 85.942796 194.523289 191.890149.0 10.898278-.950856 21.759984-2.815998 32.475405zM352.219543 548.900545l-87.369081-49.737107a3.071998 3.071998.0 01-1.682284-2.377141v-238.07983c.036571-105.87421 87.149652-191.743863 194.523289-191.743863 45.458253.0 89.490222 15.725703 124.452483 44.397682a182.601012 182.601012.0 00-6.143996 3.437712L369.37153 232.594485a33.060548 33.060548.0 00-17.005702 28.818265v.182857l-.146285 287.341509zm47.433109-100.937071 112.383919-63.999954 112.347349 63.999954v127.999909l-112.347349 63.999954-112.383919-63.999954V447.963474z" p-id="2363" fill="#bfbfbf"/></svg></a></li><li><a href='https://blog.csdn.net/qq_56914146?spm=1000.2115.3001.5343' target=_blank title=CSDN rel=me><!doctype html><svg t="1676175067454" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="2349" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M672.299893 374.246613c-30.004361-6.185886-61.073984-9.064446-91.749634-9.685593-41.186028-.835018-41.774429.635473-46.343491 40.450271-5.634324 49.097208-10.223852 98.314143-15.640212 151.144372 31.054273.64673 60.628846 2.199085 90.162486 1.626034 32.461319-.629333 63.944358-6.411013 90.443895-27.424606 29.843702-23.666002 39.58967-55.474452 34.120099-91.764983C728.039381 403.724994 705.951317 381.184629 672.299893 374.246613zM657.900951 500.909407c-23.899316 18.074657-51.306526 20.665669-82.688257 16.613376 3.77907-38.039361 7.468089-75.166957 11.500938-115.768677 18.166755 1.276063 34.453696 1.294482 50.341548 3.818979 20.170388 3.204995 36.021401 13.485129 40.776705 34.985816C683.099866 464.37533 678.124552 485.615073 657.900951 500.909407zM503.672334 369.780905c-1.798972 13.027711-3.473101 25.15082-5.205559 37.702694-25.127284-2.170432-49.036833-5.149277-73.019037-5.934153-12.665461-.414439-25.856901 1.651616-38.011732 5.276167-5.569856 1.660826-9.213849 9.779737-13.731746 14.969946 4.811586 4.14132 8.978489 10.243295 14.548344 12.07092 20.290115 6.65763 41.37534 10.943236 61.541635 17.912975 21.155832 7.312546 42.117237 17.118889 43.12417 43.801599 1.025353 27.151383-17.099447 42.173518-39.515992 51.339272-49.971112 20.434401-101.250008 18.301831-152.551418 5.27412-2.898003-.735757-6.615675-6.172583-6.522554-9.320273.313132-10.570753 2.179642-21.095457 3.244904-29.927613 30.601972 2.39556 60.002582 5.354961 89.476871 6.611581 9.122775.388856 19.11229-2.468215 27.425629-6.486738 5.1503-2.489704 10.989285-10.093892 10.780531-15.165398-.184195-4.474918-7.630794-10.624988-13.091156-12.520151-13.767562-4.780887-28.474518-6.819313-42.334177-11.387351-13.833053-4.558829-27.958772-9.378601-40.431851-16.687054-29.591969-17.339924-31.312146-47.346331-4.841262-69.316715 20.354584-16.893762 44.992727-22.240537 70.433142-25.527396C426.702312 358.37104 479.267505 361.432773 503.672334 369.780905zm455.801047 75.302033c-2.599198 35.797297-7.000438 71.464635-10.664897 107.833961-19.322068.0-37.140898.0-57.091276.0 3.668553-34.127262 6.729262-67.476811 10.968819-100.67491 4.237511-33.18275-7.367805-47.762817-40.654932-48.962132-40.755216-1.468444-40.883129-1.482771-45.26595 38.807864-3.950985 36.326347-7.580652 72.687486-11.507078 110.530372-19.435655.0-37.172621.0-55.32812.0 5.699816-58.20361 11.107989-115.27749 17.277502-172.269505.410346-3.78828 6.15007-9.250688 10.17985-10.045797 38.780235-7.6574 77.796854-12.57848 117.373221-6.016017C941.27081 371.999432 962.885084 398.084531 959.473381 445.082938zm-707.48423-86.042655c11.636015.905626 23.165606 3.169179 35.938514 4.976338-1.662873 15.230889-3.163039 28.963659-4.333702 39.687908-30.569226.0-58.112536-1.639337-85.379553.411369-34.80469 2.616594-56.879452 20.388353-63.36926 46.690392-8.036024 32.567743 5.16258 57.6807 38.144762 63.129806 25.119097 4.149507 51.359738 1.601474 77.102029 1.802042 4.854565.037862 9.718339-1.010003 13.933337-1.483794 1.093914 1.38044 1.75804 1.827625 1.74883 2.260483-.845251 41.947368-.855484 43.796482-42.837644 43.626613-31.178093-.125867-63.113433-2.62171-93.28971-9.93221-33.339316-8.077979-58.892295-29.67588-64.336284-66.284659-5.77554-38.832424 10.547217-69.608358 41.553395-91.998297C150.319587 360.548636 200.264093 355.014596 251.989151 359.040283z" p-id="2350" fill="#bfbfbf"/><path d="M137.883347 595.666538l-1.199315 1.499144c6.715959 8.794293 15.628956 15.409968 26.742061 19.847024-1.239224 1.759063-2.298346 3.357468-3.177366 4.797259-10.553357-5.196349-19.407002-12.172227-26.561959-20.925588-6.116301 7.91425-15.150048 15.150048-27.101241 21.705348-.799202-1.358951-1.798972-2.858094-2.998287-4.497431 12.351306-6.196119 21.684882-13.670348 28.000728-22.424732L137.883347 595.667561zM106.34505 646.871757h24.762987V636.43915h-19.426445v-4.376681h19.426445v-9.233292H113.90012v-4.376681h39.45357v4.376681h-17.268292v9.233292h19.48682v4.376681h-19.48682v10.432607h24.703635v4.437056h-54.44296L106.346073 646.871757zM195.804525 642.434701c2.698458-.279363 5.536087-.60989 8.513908-.989537v-18.138102h-7.374968v-4.317329h7.374968v-14.090926h-8.154727v-4.317329h20.506033v4.317329h-7.974625v14.090926h6.955412v4.317329h-6.955412v17.568121c2.39863-.339738 4.876054-.699941 7.435343-1.079588-.160659 1.599428-.25992 3.137457-.299829 4.617158-7.475252.959861-13.950733 1.858324-19.426445 2.698458L195.804525 642.434701zM216.430284 638.536928c5.216815-3.177366 10.673084-6.715959 16.368806-10.612709v-17.44737h-15.349593v-4.317329h15.349593v-10.673084h4.556783v10.673084h17.028838v4.317329h-17.028838v5.336542c.99977 3.27765 2.168386 6.315846 3.507894 9.113565 3.457752-3.357468 6.345522-6.456039 8.664334-9.293667l3.897773 3.298116c-3.298116 3.258207-6.804986 6.5553-10.522658 9.893324 3.477194 6.016017 7.804756 10.673084 12.981662 13.970176-.239454.360204-.760317.979304-1.558495 1.858324-.880043.918929-1.499144 1.639337-1.858324 2.158153-6.5553-4.736884-11.592013-11.552104-15.110139-20.445658v19.367093c0 4.756327-2.478448 7.135514-7.435343 7.135514-1.959631.0-4.057409-.020466-6.29538-.060375-.239454-1.518586-.559748-3.157923-.959861-4.916986 2.357697.279363 4.497431.419556 6.41613.419556 2.477424.0 3.717671-1.218758 3.717671-3.657296v-11.422144c-4.137227 2.87856-8.593725 6.085602-13.370519 9.623171L216.430284 638.536928zM217.749326 616.891955l3.657296-2.218528c2.598174 3.397377 5.175883 7.154957 7.735172 11.272741l-3.837398 2.638083C222.545562 623.907743 220.028229 620.009969 217.749326 616.891955zM240.593614 599.024006l2.638083-2.998287c2.837628 1.87879 5.435803 3.816932 7.794523 5.816472l-2.87856 3.298116C245.789962 602.941222 243.271606 600.902796 240.593614 599.024006zm48.027853 47.128367c1.958608-.199545 3.917216-.409322 5.875824-.629333v-22.814612h-6.595208v-3.597945h59.419298v3.597945h-31.298843v19.996426c1.918699-.279363 3.837398-.569982 5.756097-.86981-.040932.719384-.020466 1.998517.060375 3.837398-1.87879.25992-3.817955.530073-5.816472.809435v7.645121h-4.076852v-7.045463c-6.875594.979304-14.290471 2.088568-22.24463 3.327792L288.621467 646.152373zM296.955272 597.405135h41.491996v19.247366h-4.197602v-1.379417L301.152874 615.273085v1.379417h-4.197602V597.405135zM298.574143 627.504664h13.370519v-4.797259L298.574143 622.707404V627.504664zm0 8.27445399999999h13.370519v-4.797259L298.574143 630.981858V635.779118zM311.945685 643.304512v-4.047176H298.574143v5.785773C303.091016 644.502803 307.548538 643.923612 311.945685 643.304512zm22.305005-42.421159H301.152874v3.837398h33.097816V600.883353zM301.152874 611.79589h33.097816v-3.837398H301.152874V611.79589zm17.86795 18.646686v-3.477194h23.804149v3.477194c-2.038426 4.89652-4.717442 9.153474-8.035 12.770861 3.417843 2.49789 7.65433 4.397147 12.71151 5.695722-1.039679 1.518586-1.939165 2.918469-2.698458 4.197602-5.15644-1.698688-9.503445-3.997034-13.041014-6.895037-3.437286 3.078105-7.445576 5.596462-12.021801 7.55507-.679475-1.199315-1.599428-2.457981-2.75781-3.777023 4.53734-1.738597 8.443299-3.957125 11.721973-6.655584-3.338025-3.577478-5.716188-7.874341-7.135514-12.891611H319.020824zm19.246343.0h-12.651135c1.258667 3.937682 3.28686 7.305383 6.085602 10.103102C334.479911 637.628232 336.667739 634.260531 338.267167 630.442576zm41.672098 18.707061c16.488533-7.335059 25.382087-18.34788 26.681686-33.037441H381.01783v-4.676509h25.812899c.100284-5.376451.149403-10.79281.149403-16.249079h5.216815c0 5.376451-.050142 10.79281-.149403 16.249079h26.591635v4.676509h-26.681686c2.837628 15.968693 12.151761 26.501584 27.941376 31.598672-2.038426 1.958608-3.558036 3.577478-4.556783 4.856611-13.011338-5.236258-21.515013-14.560624-25.51307-27.971052-3.118014 12.131295-11.841699 21.85475-26.172079 29.170366C382.857734 652.688229 381.618511 651.149177 379.939265 649.149637zm96.29516-41.371247h23.084765V594.7077h5.15644v13.07069h23.324218v27.341718h-4.916986v-3.237741H504.47563v22.305005h-5.15644v-22.305005h-18.167778v3.237741h-4.916986L476.234425 607.77839zM481.150388 627.445312h18.167778v-15.229866h-18.167778v15.229866zM522.882861 612.215446h-18.407232v15.229866h18.407232V612.215446zM565.153594 605.199659h28.780487c-2.018983-3.837398-3.597945-6.635117-4.736884-8.394181l4.617158-2.158153c1.119497 1.719154 2.797719 4.516874 5.036713 8.394181l-4.317329 2.158153h28.180829v4.437056h-11.062963c-2.13871 11.411911-6.735401 20.585851-13.791098 27.52182 5.316076 3.877307 13.760398 7.355525 25.332968 10.432607-1.838881 2.078335-3.237741 3.816932-4.197602 5.216815-11.272741-3.897773-19.596314-7.974625-24.972764-12.231579-5.395894 4.197602-14.020318 8.43409-25.872251 12.71151-1.039679-1.39886-2.238994-2.958378-3.597945-4.676509 11.432377-3.437286 20.036335-7.265474 25.812899-11.482519-7.29515-7.794523-11.93175-16.95823-13.910824-27.491121h-11.302417L565.152571 605.199659zM606.525863 609.636714H581.25327c1.798972 9.832949 6.095835 17.958 12.891611 24.373107C600.639806 627.974361 604.7668 619.850333 606.525863 609.636714zM671.851685 604.50995h-4.466732v36.305881h4.466732v5.066389h-14.930037v-5.066389h4.466732V604.50995h-4.466732v-5.066389h14.930037V604.50995zM738.196719 604.780103h-13.401218v41.102117h-6.02625v-41.102117h-13.340843v-5.336542h32.767288L738.195695 604.780103zm33.517371 6.715959v-4.317329h19.48682v4.437056c-1.939165 3.877307-4.237511 7.544837-6.895037 11.002588v30.908964h-4.676509V628.04497c-2.198062 2.318812-4.577249 4.516874-7.135514 6.595208-.360204-1.438769-.918929-3.097548-1.679245-4.976338 6.15621-4.956895 11.252275-11.012821 15.289218-18.167778L771.71409 611.496062zM777.649266 597.105307l4.197602-2.098801c1.478677 2.358721 3.038196 5.096065 4.676509 8.214079l-4.437056 2.278903C780.527826 602.261747 779.049149 599.464027 777.649266 597.105307zM785.024234 625.946168l3.118014-2.578732c2.438539 2.717901 4.657067 5.296633 6.655584 7.735172l-3.717671 2.937912C789.161461 631.28271 787.143501 628.584252 785.024234 625.946168zM791.20091 646.991484h16.848737V617.61134h-14.270005v-4.676509h14.270005V595.36671h4.797259v17.568121h15.229866v4.676509h-15.229866v29.380144h17.028838v4.676509h-38.673811V646.991484zm76.68759-47.847751h51.565423v4.676509h-46.468334v41.851177h47.428196v4.556783h-52.524261L867.889523 599.143733zM877.601722 610.416474l3.357468-3.177366c4.996804 4.116761 10.222829 8.634658 15.679098 13.550621 4.177136-4.516874 8.184403-9.43386 12.021801-14.749936l4.376681 2.937912c-4.197602 5.436826-8.454556 10.472516-12.770861 15.110139 4.976338 4.53734 10.132778 9.393951 15.46932 14.569834l-4.137227 4.197602c-4.837168-5.056156-9.813506-10.05296-14.930037-14.989389-5.776563 5.856381-11.652388 11.012821-17.628496 15.46932-.959861-1.239224-2.238994-2.537799-3.837398-3.897773 6.275937-4.27742 12.241812-9.263991 17.897625-14.959713C888.084471 619.739816 882.918821 615.053074 877.601722 610.416474z" p-id="2351" fill="#bfbfbf"/></svg></a></li><li><a href=mailto:yifang.wangyq@foxmail.com target=_blank title=Email rel=me><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200" class="icon" p-id="3190" t="1672832977572" viewBox="0 0 1024 1024"><path fill="#979797" d="M972.8 934.274509 998.4 908.54902H127.868001C85.502225 908.54902 51.2 874.019706 51.2 831.263017V111.058823L25.6 136.784314H896.131998c42.320013.0 76.668002 34.539964 76.668002 77.07662v64.70576C972.8 292.77449 984.26151 304.292183 998.4 304.292183c14.13849.0 25.6-11.517693 25.6-25.725489v-64.70576C1024 142.916556 966.736828 85.333333 896.131998 85.333333H25.6.0v25.72549V831.263017C0 902.415639 57.205646 960 127.868001 960H998.4 1024V934.274509 457.69849c0-14.207796-11.46151-25.725489-25.6-25.725489-14.1384899999999.0-25.6 11.517693-25.6 25.725489V934.274509z" p-id="3191"/><path fill="#979797" d="M512.651558 567.164817C520.64791 572.874498 531.187889 573.490406 539.788919 568.750601l462.83587-255.056907C1015.021598 306.862133 1019.560139 291.225196 1012.761901 278.767619 1005.963665 266.310041 990.403006 261.749254 978.006197 268.580816L515.170327 523.637722 542.307689 525.223505 194.028065 276.539467C182.502788 268.310009 166.520953 271.027598 158.331639 282.609372S152.846657 310.251322 164.371935 318.480781L512.651558 567.164817z" p-id="3192"/></svg></a></li><li><a href=https://github.com/kurisaW/kurisaW.github.io target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com/KurisaWhh target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li><li><a href=https://raw.githubusercontent.com/kurisaW/picbed/main/img/202302121550487.png target=_blank title=wechat rel=me><!doctype html><svg t="1676174392026" class="icon" viewBox="0 0 1194 1024" xmlns="http://www.w3.org/2000/svg" p-id="2999" xmlns:xlink="http://www.w3.org/1999/xlink" width="233.203125" height="200"><path d="M728.064 535.296a35.498667 35.498667.0 11-70.912.0 35.498667 35.498667.0 0170.912.0m246.016.0a35.498667 35.498667.0 11-70.997333.0 35.498667 35.498667.0 0170.997333.0" fill="#cdcdcd" p-id="3e3"/><path d="M902.144 930.133333l-6.656 1.450667a594.176 594.176.0 01-18.602667 3.669333c-26.453333 4.778667-44.629333 6.826667-64 6.144C645.034666 935.850666 514.218666 853.504 461.824 722.688a446.464 446.464.0 01-6.826667-19.114667l-1.962666-6.058666a199.68 199.68.0 01-3.84-13.653334 338.858667 338.858667.0 01-9.216-75.690666c0-171.008 157.013333-305.92 354.304-314.709334l8.874666-.682666c7.850667-.597333 12.970667-.853333 18.773334-.853334h14.762666l9.301334.170667c188.16 14.677333 340.394667 156.672 340.394666 323.925333.0 78.336-38.826667 155.733333-109.653333 222.293334a303.530667 303.530667.0 01-7.082667 6.4l9.984 71.082666a49.152 49.152.0 01-69.12 58.453334l-98.816-46.421334a582.485333 582.485333.0 01-9.472 2.304zm220.16-314.026666c0-131.754667-124.586667-247.978667-279.125333-260.096H821.930667c-3.754667.0-7.68.085333-13.994667.597333l-10.666667.768C631.466667 364.8 503.978667 474.453333 503.978667 608.256c0 18.773333 2.730667 40.874667 7.509333 60.842667.597333 2.474667 1.450667 5.632 2.56 9.216l1.706667 4.949333c2.133333 6.570667 4.266667 12.629333 5.632 15.957333 42.325333 105.728 149.930667 173.397333 293.717333 178.176 13.738667.512 28.16-1.109333 50.346667-5.12a531.626667 531.626667.0 0016.64-3.242666l5.632-1.28c4.693333-1.109333 8.448-1.962667 19.370666-4.778667a32 32 0 0121.418667 2.133333L1013.76 905.216l-9.984-69.290667a32 32 0 0113.909333-31.232c1.194667-.853333 8.618667-6.912 15.189334-13.056 58.709333-55.210667 89.429333-116.394667 89.429333-175.616zM12.970667 378.197333C12.970667 171.52 206.677333 5.376 442.709333 5.376c208.384.0 394.24 130.304 431.872 306.090667 1.28 5.973333 1.28 11.264.512 16.896a32 32 0 01-63.658666-5.973334C779.178667 179.2 621.482667 69.376 442.709333 69.376c-202.666666.0-365.738666 139.776-365.738666 308.906667.0 89.941333 46.165333 171.52 136.021333 237.568a32 32 0 0111.434667 35.84l-23.296 69.973333 104.96-48.896a32 32 0 0122.442666-1.706667l5.461334 1.706667c54.357333 11.093333 76.288 14.506667 108.714666 14.506667a200.789333 200.789333.0 0032.256-4.010667c-.512.170667-1.536.512-2.730666 1.536a33.109333 33.109333.0 0139.253333 1.109333A32 32 0 01516.864 730.88c-11.776 14.848-47.36 20.309333-74.24 20.309333-37.12.0-62.037333-3.584-119.893333-15.530666L198.570667 793.6a49.493333 49.493333.0 01-68.949334-59.733333l26.88-80.64c-93.525333-75.52-143.530666-170.24-143.530666-275.029334z" fill="#cdcdcd" p-id="3001"/><path d="M344.576 254.378667a44.373333 44.373333.0 11-88.746667.085333 44.373333 44.373333.0 0188.746667.0M636.586667 254.378667A44.373333 44.373333.0 11547.84 254.464a44.373333 44.373333.0 0188.746667.0" fill="#cdcdcd" p-id="3002"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/documents/><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200" class="icon" p-id="3578" t="1675865124368" viewBox="0 0 1024 1024"><path fill="#b4b4b5" d="M749.942 901.944H278.8c-72.2.0-130.953-55.225-130.953-123.078V245.494c0-67.854 58.752-123.078 130.953-123.078h383.551c6.596.0 12.937 2.505 17.794 6.954l192.363 178.046c5.318 4.96 8.387 11.914 8.387 19.226v452.223c0 67.855-58.753 123.079-130.953 123.079zM278.8 174.777c-43.31.0-78.592 31.703-78.592 70.717v533.372c0 39.015 35.282 70.717 78.592 70.717h471.142c43.311.0 78.592-31.702 78.592-70.717v-440.77l-176.461-163.32H278.8z" p-id="3579"/><path fill="#b4b4b5" d="M832.573 332.319H671.452c-14.471.0-26.181-11.709-26.181-26.18V156.982c0-14.471 11.71-26.18 26.181-26.18s26.181 11.709 26.181 26.18v122.976h134.94c14.471.0 26.181 11.71 26.181 26.181s-11.71 26.18-26.181 26.18z" p-id="3580"/><path fill="#b4b4b5" d="M320.473 760.202c-10.227.0-20.197-3.067-29.708-9.051-22.448-14.163-25.106-33.083-24.646-43.104.818-19.687 12.221-51.083 99.199-98.074 15.34-59.979 25.566-137.446 26.845-203.613-47.094-48.781-66.882-87.387-60.388-117.862 2.25-10.584 10.073-29.913 36.969-40.14 16.567-6.392 34.055-2.557 46.583 10.073 7.107 7.107 28.174 28.277 29.248 126.299 47.759 45.815 117.402 97.563 178.763 132.793 23.316-4.244 43.821-6.392 61.104-6.392 68.979.0 77.672 36.663 78.234 52.463.512 16.056-5.932 26.231-11.402 31.958-5.829 5.983-16.517 13.091-34.669 13.091-23.368.0-57.576-12.067-101.908-35.947-64.173 14.011-142.407 41.93-204.994 73.172-22.859 76.904-52.107 114.334-89.23 114.334zm108.454-183.415-.767 2.762c38.708-16.823 80.381-32.01 120.164-43.771l-4.296-2.353 4.04-.817c-36.049-23.777-72.047-50.725-103.698-77.672v3.579l-2.148-2.096c-2.965 40.907-8.539 82.989-16.158 121.85l2.863-1.482z" p-id="3581"/></svg>
<span>Documents</span></a></li><li><a href=/explore/><!doctype html><svg t="1681284028043" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="4393" xmlns:xlink="http://www.w3.org/1999/xlink" width="100" height="100"><path d="M786.046928.082867c-6.061942.163285-12.348401.571496-18.491985 1.285866-24.492695 2.775839-49.760993 9.490919-73.988351 18.491986-48.475126 18.022541-93.133474 45.291076-121.830749 73.98835-31.024081 31.024081-46.250373 68.885706-45.923804 107.788271.244927 33.657046 12.838255 67.62025 31.248597 100.134303L510.504104 348.981314a20.492222 20.492222.0 00-7.102881 20.492221c1.75531 7.572325 7.75602 13.552625 15.307934 15.307935 7.653967 1.75531 15.552862-1.020529 20.492222-7.102882l57.41496-57.394549a20.390169 20.390169.0 002.551323-25.513225c-20.900433-32.289537-32.289537-64.191273-32.534464-93.133474-.244927-28.942202 9.735846-55.006512 33.79992-79.090996 22.329174-22.308763 64.4362-48.230199 107.808681-64.415789a239.803899 239.803899.0 0177.151991-14.675207l-77.151991 76.539674a9.51133 9.51133.0 00-.653139 1.285866c-20.961665 23.921199-21.920962 60.354084.653139 82.907774l108.420998 108.46182.632728.632728c23.921199 20.961665 60.354084 21.920962 82.928185-.632728l77.172401-77.172401a237.232166 237.232166.0 01-14.675206 77.805129c-16.103947 43.127555-42.004973 84.744726-64.415789 107.155543-24.084484 24.084484-49.679351 32.922265-78.458268 32.534463-28.778917-.408212-61.395023-11.715673-95.031658-31.901736a20.41058 20.41058.0 00-24.880497 3.204461l-32.514053 32.514054a20.533043 20.533043.0 0028.697275 29.350413l22.961902-22.961902c33.167192 17.757204 66.497668 30.126015 100.134303 30.615869 38.575995.551086 76.7846-13.634267 107.78827-44.658348 28.636043-28.615633 55.965809-72.947411 73.988351-121.17761 18.022542-48.25061 27.513461-100.542515 12.756612-144.792652a20.43099 20.43099.0 00-14.736438-13.226055A20.512632 20.512632.0 00979.947434 175.491387L871.506025 283.279658c-5.714962 5.735373-17.532688 6.531385-26.125542.0-.408212-.306159-.898065-.306159-1.285867-.632728L736.939074 175.491387c-6.061942-6.061942-6.388511-18.736912 1.265456-27.431818L845.360072 40.904026c5.021003-4.93936 7.102882-12.103474 5.592499-19.043071A20.43099 20.43099.0 00837.685694 7.104106c-16.328464-5.572088-33.554993-7.572325-51.659176-7.021239zM68.492594 2.001461c-4.306632.632728-8.368338 2.632965-11.491156 5.735373l-51.026449 51.026449A20.41058 20.41058.0 002.790938 83.64378l86.112236 149.262568a20.41058 20.41058.0 0020.410579 9.552151l44.637937-7.021239L430.780381 512.26595l-10.20529 10.20529a57.700708 57.700708.0 000 81.642318l14.022068 14.675206c16.267232 16.267232 38.678048 16.18559 58.680416 9.552152l34.453059 33.82033c-2.326806 27.493051 5.735373 54.843227 25.513224 74.621079L801.96718 986.179196a128.954042 128.954042.0 00182.42976.0v-.653138c48.373074-50.863164 49.026212-132.729999.0-181.776622L735.020479 555.005703c-20.573864-20.573864-47.924041-26.941965-74.621078-25.513224l-33.820331-34.453058c6.633438-20.002368 6.715081-42.413184-9.552151-58.680416l-14.675207-14.022069a57.863993 57.863993.0 00-40.821159-17.226529c-14.838491.0-29.59534 5.9803-40.821159 17.226529l-10.20529 10.20529-276.82869-276.849101 7.02124-44.637937a20.41058 20.41058.0 00-9.572562-20.41058L81.881934 4.552784A19.981957 19.981957.0 0070.390778 2.001461h-1.898184zm7.021239 45.923804 123.075795 70.804301-6.368101 41.453887c-.877655 6.306869 1.285867 12.67497 5.735373 17.226529L481.82724 461.239501l-22.349584 22.329174-283.829519-283.84993a20.594275 20.594275.0 00-17.22653-5.714962l-41.453887 6.368101L46.16342 77.275679zm486.01672 398.639029c4.551559.0 9.082708 1.428741 12.123885 4.469917l14.022068 14.675207a16.940781 16.940781.0 011.285866 22.961902 20.41058 20.41058.0 001.265456 28.064547l46.576943 46.556532c4.694433 4.694433 11.307461 6.857955 17.859257 5.735373 18.879786-3.102408 38.657638 1.673668 51.638766 14.675206L955.066937 833.09985c32.534464 32.514053 32.861033 88.806432.0 123.728933-35.310303 35.310303-88.418631 35.310303-123.728933.0L581.941133 708.08505c-13.552625-13.552625-18.900197-32.779391-14.675207-49.760993a20.328937 20.328937.0 00-5.735373-19.757441l-46.556532-46.576942a20.41058 20.41058.0 00-28.064547-1.265456 16.940781 16.940781.0 01-22.961902-1.285867L449.272366 575.416283c-6.061942-6.061942-6.061942-18.165416.0-24.247769L549.406669 451.034211c3.041176-3.020766 7.572325-4.469917 12.123884-4.469917zm-200.289017 61.231739a20.512632 20.512632.0 00-12.103473 6.388511l-96.950253 96.950253c-13.879194-2.714607-27.513461-5.102645-41.453887-5.102645-115.054437.0-208.596123 93.521275-208.596123 208.555302C2.15821 929.662301 95.699896 1022.530438 210.754333 1022.530438c114.993205.0 207.902164-92.8681370000001 207.902164-207.942984.0-14.899723-3.347335-29.656572-7.02124-44.00521l70.171573-70.151161a20.533043 20.533043.0 00-28.717686-29.350414l-77.15199 77.82554a20.533043 20.533043.0 00-5.102645 21.676035c5.102645 13.552625 7.000829 27.186892 7.000828 44.025621A166.060475 166.060475.0 01210.713512 981.709279c-93.113064.0-167.734143-73.988351-167.734142-167.121825a167.142236 167.142236.0 01167.754553-167.734143c14.573154.0 29.24836 2.061469 44.005209 5.735373 6.939597 1.510383 14.185353-.632728 19.124713-5.735373L377.835337 542.881819a20.451401 20.451401.0 00-14.675206-35.085786h-1.898184zM647.642788 620.05422 618.271964 649.425044l244.926955 244.926955 29.350413-29.350414zM232.409958 695.961166a20.533043 20.533043.0 00-3.18405.632728L133.5207 723.392985a20.369758 20.369758.0 00-14.022068 14.022068L92.699541 833.12026a20.349348 20.349348.0 005.102645 20.41058l71.437029 71.437028c5.184287 5.102645 12.756612 7.082471 19.777851 5.102645l98.236119-26.799091a20.41058 20.41058.0 0014.654797-14.654796l24.247768-95.684797a20.349348 20.349348.0 00-5.102645-19.777852l-71.437028-71.437028a20.594275 20.594275.0 00-17.226529-5.735373zm-3.837189 43.372481 54.863638 54.863638-18.491985 73.335212-74.621079 19.777852-54.863638-54.863638 19.777852-73.335212z" p-id="4394" fill="#bfbfbf"/></svg>
<span>Explore</span></a></li><li><a href=/quote/><!doctype html><svg t="1681344381208" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="3501" xmlns:xlink="http://www.w3.org/1999/xlink" width="100" height="100"><path d="M945.453 689.878l-131.829-19.156-58.226-117.979-.408-.826c-2.281-4.622-6.955-7.293-11.911-7.93-.141-.019-.283-.026-.425-.042a18.335 18.335.0 00-1.123-.092c-.263-.012-.525-.007-.788-.007s-.525-.005-.788.007c-.376.016-.749.053-1.123.092-.142.016-.284.023-.425.042-4.956.637-9.63 3.308-11.911 7.93l-58.635 118.806-130.916 19.022-.912.133c-12.623 1.834-15.369 19.692-7.28 27.577l94.167 91.791-21.738 126.741-.155.907c-1.024 5.969-.23 11.58 4.243 16.054 5.418 5.419 13.388 6.054 19.995 2.58l115.479-60.71L855.407 955.1l.815.429c5.286 2.779 11.389 3.086 16.656.0 6.853-4.014 8.852-11.232 7.582-18.634l-21.894-127.65c31.169-30.382 62.338-60.765 93.508-91.146l.659-.644c8.089-7.885 5.343-25.743-7.28-27.577zM829.896 791.111c-7.854 7.656-4.673 18.04-3.057 27.462l6.803 39.66 9.082 52.949-92.838-48.808c-10.396-5.466-18.287.0-27.139 4.653l-35.617 18.725-48.369 25.429 17.575-102.466c1.161-6.771.177-12.804-4.884-17.737l-7.025-6.848-28.814-28.088-39.85-38.843 106.551-15.482c9.24-1.343 12.327-10.865 15.86-18.024l17.983-36.437 24.585-49.815 47.248 95.735c4.432 8.979 13.309 8.851 21.646 10.062l40.211 5.843 55.875 8.119c-25.275 24.637-50.55 49.275-75.826 73.911z" p-id="3502" fill="#bfbfbf"/><path d="M479 893.514H163.112c-15.779.0-19.088-11.404-19.088-15.792v-765.49c0-5.564 5.024-15.709 15.5-15.709s694.962-.126 705.219-.126 14.4 8.372 14.4 14.238l.029 450.611c0 8.994 7.506 16.5 16.5 16.5s16.5-7.506 16.5-16.5V113.691c0-16.642-7.154-31.122-20.447-41.116-12.164-9.144-25.964-9.053-40.108-9.053h-690.93c-14.416.0-28.784 5.788-38.03 17.108-7.786 9.532-11.633 20.747-11.633 33.035v763.792c0 18.321 10.354 36.11 27.115 44.028 15.061 7.114 33.404 5.029 49.662 5.029h291.2c8.994.0 16.5-7.506 16.5-16.5s-7.507-16.5-16.501-16.5z" p-id="3503" fill="#bfbfbf"/><path d="M784.649 255.605c0-8.995-7.506-16.5-16.5-16.5h-512.1c-8.995.0-16.5 7.505-16.5 16.5s7.505 16.5 16.5 16.5h512.1c8.995.0 16.5-7.505 16.5-16.5zM763.5 485.092c0-8.995-7.506-16.5-16.5-16.5H256.05c-8.995.0-16.5 7.505-16.5 16.5s7.505 16.5 16.5 16.5H747c8.994.0 16.5-7.506 16.5-16.5zM256.05 694.439c-8.995.0-16.5 7.506-16.5 16.5s7.505 16.5 16.5 16.5H459c8.994.0 16.5-7.506 16.5-16.5s-7.506-16.5-16.5-16.5H256.05z" p-id="3504" fill="#bfbfbf"/></svg>
<span>Quote</span></a></li><li><a href=/about/><!doctype html><svg t="1676123776346" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="2322" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M371.319957 639.999233c-.201591-.167822-.348947-.37453-.555655-.538259-68.492954-54.16155-97.717555-109.608374-97.717555-185.393407.0-17.250896-13.981433-31.236422-31.236422-31.236422s-31.237445 13.986549-31.237445 31.236422c0 83.274612 30.083156 151.037948 94.031607 210.831776C207.274764 741.187843 153.244196 819.379693 126.838803 920.827199c-4.341888 16.696264 5.664 33.758871 22.360264 38.10076 2.644223.681522 5.287423 1.017166 7.890714 1.017166 13.880125.0 26.549679-9.324366 30.210046-23.376407 25.166169-96.705506 80.644715-169.906691 185.489598-244.770749 14.042831-10.026354 17.295921-29.53364 7.270591-43.571355C377.636826 644.831284 374.640586 642.099057 371.319957 639.999233z" fill="#bfbfbf" p-id="2323"/><path d="M898.081149 920.725892c-26.666336-101.043301-79.924307-178.587398-175.113273-253.587556 65.422012-59.791781 96.186689-128.295991 96.186689-213.069747.0-17.250896-13.981433-31.236422-31.236422-31.236422s-31.237445 13.986549-31.237445 31.236422c0 75.748195-30.540573 133.269259-98.849332 186.244798-4.272303 2.204202-8.149611 5.301749-11.131525 9.484002-10.026354 14.037714-6.77224 33.545 7.270591 43.571355 104.58087 74.680886 157.811212 145.167241 183.710069 243.301282 3.691065 14.012132 16.340153 23.275099 30.179346 23.275099 2.63399.0 5.318122-.335644 7.992021-1.046842C892.52869 954.493973 902.483412 937.411923 898.081149 920.725892z" fill="#bfbfbf" p-id="2324"/><path d="M237.548254 388.711046c16.950044-2.933819 28.329209-19.080567 25.460882-36.046984-.152473-.880043-14.224979-88.50473 39.96113-152.621003 40.98853-48.507784 111.281479-73.099878 208.927403-73.099878 97.726765.0 168.193677 24.638143 209.456453 73.226768 54.492078 64.161299 40.866756 151.766542 40.733727 152.528905-2.918469 17.001209 8.490372 33.154098 25.501814 36.07666 1.789763.310062 3.569292.457418 5.328355.457418 14.926968.0 28.125571-10.737552 30.749328-25.948999.803295-4.703115 18.953677-116.172883-54.146201-202.912409C715.89376 96.735182 629.209492 64.47136 511.898693 64.47136c-117.30159.0-203.823152 32.258705-257.1855 95.886861-72.794933 86.806042-54.074569 198.367907-53.240575 203.075115C204.470905 380.38338 220.658585 391.670447 237.548254 388.711046z" fill="#bfbfbf" p-id="2325"/><path d="M401.406183 366.915647c-17.256012.0-31.237445 13.986549-31.237445 31.237445v33.320896c0 17.250896 13.981433 31.236422 31.237445 31.236422s31.236422-13.986549 31.236422-31.236422v-33.320896C432.642604 380.902196 418.661172 366.915647 401.406183 366.915647z" fill="#bfbfbf" p-id="2326"/><path d="M623.541399 366.915647c-17.256012.0-31.237445 13.986549-31.237445 31.237445v33.320896c0 17.250896 13.981433 31.236422 31.237445 31.236422s31.236422-13.986549 31.236422-31.236422v-33.320896C654.778844 380.902196 640.797411 366.915647 623.541399 366.915647z" fill="#bfbfbf" p-id="2327"/><path d="M589.505211 498.986615c-14.317077-9.410324-33.585933-5.398964-43.164079 8.759501-.132006.193405-13.615089 19.756973-34.175357 19.756973-19.990287.0-32.43676-18.119683-33.270754-19.37528-9.182127-14.418384-28.288277-18.816554-42.838667-9.761318-14.652721 9.105379-19.157315 28.369118-10.045797 43.021839 11.215436 18.043958 41.974997 48.588625 86.155219 48.588625 43.967374.0 75.112722-30.316469 86.582961-48.233538C607.970772 527.3455 603.781356 508.386706 589.505211 498.986615z" fill="#bfbfbf" p-id="2328"/></svg>
<span>About</span></a></li><li><a href=/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#1fal组件>1.FAL组件</a><ol><li><a href=#11什么是fal>1.1什么是FAL</a></li><li><a href=#12-使用env配置fal>1.2 使用ENV配置FAL</a></li><li><a href=#13-fal-sfud-移植>1.3 FAL SFUD 移植</a></li><li><a href=#14-fal-sfud-测试用例>1.4 FAL SFUD 测试用例</a></li><li><a href=#15-测试结果>1.5 测试结果</a></li></ol></li><li><a href=#2dfs文件系统>2.DFS文件系统</a><ol><li><a href=#21-什么是dfs>2.1 什么是DFS</a></li><li><a href=#22-dfs架构>2.2 DFS架构</a></li><li><a href=#23-使用env配置dfs>2.3 使用ENV配置DFS</a></li><li><a href=#24-dfs挂载到fal分区测试>2.4 DFS挂载到FAL分区测试</a></li><li><a href=#25-测试结果>2.5 测试结果</a></li></ol></li><li><a href=#3easyflash移植到fal分区>3.Easyflash移植到FAL分区</a><ol><li><a href=#31-简述easyflash>3.1 简述EasyFlash</a></li><li><a href=#32easyflash软件包使用>3.2EasyFlash软件包使用</a></li><li><a href=#33-移植easyflash>3.3 移植easyflash</a></li><li><a href=#34-编写easyflash测试用例>3.4 编写Easyflash测试用例</a></li><li><a href=#35-测试结果>3.5 测试结果</a></li></ol></li><li><a href=#4结语>4.结语</a></li><li><a href=#5联系>5.联系</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/nxplpc55s69_fal%E5%88%86%E5%8C%BA%E7%AE%A1%E7%90%86%E4%B8%8Eeasyflash%E5%8F%98%E9%87%8F%E7%AE%A1%E7%90%86/><img src=/p/nxplpc55s69_fal%E5%88%86%E5%8C%BA%E7%AE%A1%E7%90%86%E4%B8%8Eeasyflash%E5%8F%98%E9%87%8F%E7%AE%A1%E7%90%86/cover_hue90c124f4d3c5094341e1772579f0b35_161591_800x0_resize_q75_box.jpg srcset="/p/nxplpc55s69_fal%E5%88%86%E5%8C%BA%E7%AE%A1%E7%90%86%E4%B8%8Eeasyflash%E5%8F%98%E9%87%8F%E7%AE%A1%E7%90%86/cover_hue90c124f4d3c5094341e1772579f0b35_161591_800x0_resize_q75_box.jpg 800w, /p/nxplpc55s69_fal%E5%88%86%E5%8C%BA%E7%AE%A1%E7%90%86%E4%B8%8Eeasyflash%E5%8F%98%E9%87%8F%E7%AE%A1%E7%90%86/cover_hue90c124f4d3c5094341e1772579f0b35_161591_1600x0_resize_q75_box.jpg 1600w" width=800 height=341 loading=lazy alt="Featured image of post 【NXP】LPC55S69_FAL分区管理与easyflash变量管理"></a></div><div class=article-details><header class=article-category><a href=/categories/nxp%E5%AD%A6%E4%B9%A0/ style=background-color:#2a9d8f;color:#fff>NXP学习</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/nxplpc55s69_fal%E5%88%86%E5%8C%BA%E7%AE%A1%E7%90%86%E4%B8%8Eeasyflash%E5%8F%98%E9%87%8F%E7%AE%A1%E7%90%86/>【NXP】LPC55S69_FAL分区管理与easyflash变量管理</a></h2><h3 class=article-subtitle>FAL分区管理与easyflash变量管理</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Apr 23, 2023</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>16 minute read</time></div></footer></div></header><section class=article-content><h2 id=1fal组件>1.FAL组件</h2><h3 id=11什么是fal>1.1什么是FAL</h3><p>FAL (Flash Abstraction Layer) Flash 抽象层，是对 Flash 及基于 Flash 的分区进行管理、操作的抽象层，对上层统一了 Flash 及 分区操作的 API (框架图如下所示)，并具有以下特性：</p><ul><li>支持静态可配置的分区表，并可关联多个 Flash 设备；</li><li>分区表支持 <strong>自动装载</strong> 。避免在多固件项目，分区表被多次定义的问题；</li><li>代码精简，对操作系统 <strong>无依赖</strong> ，可运行于裸机平台，比如对资源有一定要求的 Bootloader；</li><li>统一的操作接口。保证了文件系统、OTA、NVM（例如：<a class=link href=https://github.com/armink-rtt-pkgs/EasyFlash target=_blank rel=noopener>EasyFlash</a>） 等对 Flash 有一定依赖的组件，底层 Flash 驱动的可重用性；</li><li>自带基于 Finsh/MSH 的测试命令，可以通过 Shell 按字节寻址的方式操作（读写擦） Flash 或分区，方便开发者进行调试、测试；</li></ul><p><img src=https://raw.githubusercontent.com/kurisaW/picbed/main/img2023/202304231620423.png loading=lazy alt=image-20230423162047252></p><p>通过上图我们也可以清晰明了看到，FAL抽象层向下可以通过Flash硬件进行统一管理，当然也可以使用SFUD框架（串行Flash通用驱动库，这部分RT-Thread官方已完成框架的移植同时提供多个应用历程），而对上也可以使用如DFS、NVM提供的Flash硬件统一访问接口，方便用户更加直接方便对底层flash硬件的访问操作。</p><p>注：非易失性存储器 (NVM)：在芯片电源关闭期间保存存储在其中的数据。 因此，它被用于没有磁盘的便携式设备中的内存，以及用于可移动存储卡等用途。 主要类型有：非易失性半导体存储器 (Non-volatile semiconductor memory, NVSM) 将数据存储在浮栅存储单元中，每个单元都由一个浮栅(floating-gate) MOSFET 组成。</p><p>关于存储，可以用一张图来解释：</p><p><img src=https://raw.githubusercontent.com/kurisaW/picbed/main/img2023/202304231641751.png loading=lazy alt=image-20230423164134689></p><blockquote><p>来源：<a class=link href=https://blog.csdn.net/lianyunyouyou/article/details/118277207 target=_blank rel=noopener>ROM、RAM、FLASH、NVM……一文搞定</a></p></blockquote><h3 id=12-使用env配置fal>1.2 使用ENV配置FAL</h3><p>在RT-Thread v4.1.0之前，FAL是作为软件包形式对用户开放使用的，而v4.1.0之后，FAL被RT-Thread官方重新定义为RTT组件的一部分，这样也能更加方便用户的开发。</p><p>我们下面正式讲解FAL组件的使用：</p><p>首先打开ENV工具，根据以下路径打开FAL使能<code>RT-Thread Components->[*]FAL: flash abstraction layer</code>，由于我们后面会用到SFUD，所以这里把<code>FAL uses SFUD drivers</code>一并使能，并修改FAL设备名称为<code>W25Q128</code>.</p><p><img src=https://raw.githubusercontent.com/kurisaW/picbed/main/img2023/202304231647583.png loading=lazy alt=image-20230423164700491></p><p>完成上述操作后保存退出，并使用<code>scons --target=mdk5</code>重新生成MDK5文件并打开</p><h3 id=13-fal-sfud-移植>1.3 FAL SFUD 移植</h3><p>为了提供示例，我们选用<code>W25Q128 spi flash</code>作为测试模块，并且使用SFUD框架对spi flash设备进行管理和驱动。</p><p>由于目前RT-Thread的SFUD已经对<code>W25Q128 </code>完成支持，根据官方的使用手册，我们仅需编写<code>fal_cfg.h</code>文件完成对<code>FAL_FLASH_DEV_TABLE</code>及<code>FAL_PART_TABLE</code>的定义即可。文件存放路径：<code>.\rt-thread\bsp\lpc55sxx\lpc55s69_nxp_evk\board\ports\fal_cfg.h</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// fal.cfg.h
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Copyright (c) 2006-2023, RT-Thread Development Team
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * SPDX-License-Identifier: Apache-2.0
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * Change Logs:
</span></span></span><span class=line><span class=cl><span class=cm> * Date           Author       Notes
</span></span></span><span class=line><span class=cl><span class=cm> * 2023-04-21     Wangyuqiang  the first version
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=cp>#ifndef _FAL_CFG_H_
</span></span></span><span class=line><span class=cl><span class=cp>#define _FAL_CFG_H_
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;rtthread.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;board.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#ifndef FAL_USING_NOR_FLASH_DEV_NAME
</span></span></span><span class=line><span class=cl><span class=cp>#define NOR_FLASH_DEV_NAME             &#34;norflash0&#34;
</span></span></span><span class=line><span class=cl><span class=cp>#else
</span></span></span><span class=line><span class=cl><span class=cp>#define NOR_FLASH_DEV_NAME              FAL_USING_NOR_FLASH_DEV_NAME
</span></span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/* Flash device Configuration */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>extern</span> <span class=k>struct</span> <span class=n>fal_flash_dev</span> <span class=n>nor_flash0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* flash device table */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define FAL_FLASH_DEV_TABLE                                          \
</span></span></span><span class=line><span class=cl><span class=cp>{                                                                    \
</span></span></span><span class=line><span class=cl><span class=cp>    &amp;nor_flash0,                                                     \
</span></span></span><span class=line><span class=cl><span class=cp>}
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/* Partition Configuration */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#ifdef FAL_PART_HAS_TABLE_CFG
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/* partition table */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define FAL_PART_TABLE                                                                                                  \
</span></span></span><span class=line><span class=cl><span class=cp>{                                                                                                                       \
</span></span></span><span class=line><span class=cl><span class=cp>    {FAL_PART_MAGIC_WROD,  &#34;easyflash&#34;, NOR_FLASH_DEV_NAME,                                    0,       512 * 1024, 0}, \
</span></span></span><span class=line><span class=cl><span class=cp>    {FAL_PART_MAGIC_WROD,   &#34;download&#34;, NOR_FLASH_DEV_NAME,                           512 * 1024,      1024 * 1024, 0}, \
</span></span></span><span class=line><span class=cl><span class=cp>    {FAL_PART_MAGIC_WROD, &#34;wifi_image&#34;, NOR_FLASH_DEV_NAME,                  (512 + 1024) * 1024,       512 * 1024, 0}, \
</span></span></span><span class=line><span class=cl><span class=cp>    {FAL_PART_MAGIC_WROD,       &#34;font&#34;, NOR_FLASH_DEV_NAME,            (512 + 1024 + 512) * 1024,  7 * 1024 * 1024, 0}, \
</span></span></span><span class=line><span class=cl><span class=cp>    {FAL_PART_MAGIC_WROD, &#34;filesystem&#34;, NOR_FLASH_DEV_NAME, (512 + 1024 + 512 + 7 * 1024) * 1024,  7 * 1024 * 1024, 0}, \
</span></span></span><span class=line><span class=cl><span class=cp>}
</span></span></span><span class=line><span class=cl><span class=cp>#endif </span><span class=cm>/* FAL_PART_HAS_TABLE_CFG */</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#endif </span><span class=cm>/* _FAL_CFG_H_ */</span><span class=cp>
</span></span></span></code></pre></td></tr></table></div></div><p>此时编译的话是找不到该头文件的，需要我们在Keil中设置：</p><p><img src=https://raw.githubusercontent.com/kurisaW/picbed/main/img2023/202304231748300.png loading=lazy alt=image-20230423174802203></p><p>在RTT FAL组件中的SFUD提供的<code>fal_flash_dev</code>对象默认的<code>nor_flash0</code>参数中，flash大小默认为8M，而<code>W25Q128</code>最大最16M，我们可以选择在<code>.\rt-thread\components\fal\samples\porting\fal_flash_sfud_port.c</code>文件中对<code>struct fal_flash_dev nor_flash0</code>进行修改：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>fal_flash_dev</span> <span class=n>nor_flash0</span> <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>name</span>       <span class=o>=</span> <span class=n>FAL_USING_NOR_FLASH_DEV_NAME</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>addr</span>       <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>len</span>        <span class=o>=</span> <span class=mi>16</span> <span class=o>*</span> <span class=mi>1024</span> <span class=o>*</span> <span class=mi>1024</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>blk_size</span>   <span class=o>=</span> <span class=mi>4096</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>ops</span>        <span class=o>=</span> <span class=p>{</span><span class=n>init</span><span class=p>,</span> <span class=n>read</span><span class=p>,</span> <span class=n>write</span><span class=p>,</span> <span class=n>erase</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>write_gran</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>当然也可以选择不进行修改，根据大佬的原话就是<strong>因为在调用初始化接口函数init后，会从flash设备读取正确的参数更新到nor_flash0表项中，我们在使用FAL组件前都需要调用FAL初始化函数fal_init，其内调用flash设备初始化函数fal_flash_init，最后会调用注册到fal_flash_dev设备表项中的初始化函数device_table[i]->ops.init，所以nor_flash0表项参数会在FAL初始化时被更新。</strong></p><p>同时我们需要开启SFUD框架支持，打开ENV工具，由于SFUD的使用需要指定一个spi设备，这里我选择使用最近移植好的软件spi，路径<code>Hardware Drivers Config->On-chip Peripheral Drivers->[*] Enable soft SPI BUS-> [*] Enable soft SPI1 BUS (software simulation)</code>，这里我的测试开发板是恩智浦的LPC55S69-EVK，并且这款bsp的软件模拟spi由我本人对接，关于这部分的软件spi引脚定义可以选用默认即可，当然也可以使用自定义引脚，记住不要与其他引脚产生冲突。</p><p><img src=https://raw.githubusercontent.com/kurisaW/picbed/main/img2023/202304231712081.png loading=lazy alt=image-20230423171229953></p><p>此时我们回到ENV主界面，进入<code>RT-Thread Components->Device Drivers->Using Serial Flash Universal Driver</code>，此时我们才可以看到SFUD选项出现（如果没有使能spi是没法看到的），使能后保持默认即可</p><p><img src=https://raw.githubusercontent.com/kurisaW/picbed/main/img2023/202304231716493.png loading=lazy alt=image-20230423171646352></p><p>到这里，ENV的配置暂时告一段落！</p><h3 id=14-fal-sfud-测试用例>1.4 FAL SFUD 测试用例</h3><p>为了验证<code>W25Q128</code>及软件模拟spi在SFUD框架上是否能够成功运行，我们在<code>.\rt-thread\bsp\lpc55sxx\lpc55s69_nxp_evk\board\ports\</code>下新建一个<code>soft_spi_flash_init.c</code>文件，代码如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Copyright (c) 2006-2023, RT-Thread Development Team
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * SPDX-License-Identifier: Apache-2.0
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * Change Logs:
</span></span></span><span class=line><span class=cl><span class=cm> * Date           Author       Notes
</span></span></span><span class=line><span class=cl><span class=cm> * 2023-04-21     Wangyuqiang  the first version
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;rtthread.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;spi_flash.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;spi_flash_sfud.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;drv_soft_spi.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;drv_pin.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;rtconfig.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define cs_pin	GET_PINS(1,9)
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>rt_soft_spi_flash_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>result</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=nf>rt_hw_softspi_device_attach</span><span class=p>(</span><span class=s>&#34;sspi1&#34;</span><span class=p>,</span> <span class=s>&#34;sspi10&#34;</span><span class=p>,</span> <span class=n>cs_pin</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;value is %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span><span class=n>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=n>result</span> <span class=o>==</span> <span class=n>RT_EOK</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;rt_hw_softspi_device_attach successful!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>RT_NULL</span> <span class=o>==</span> <span class=nf>rt_sfud_flash_probe</span><span class=p>(</span><span class=s>&#34;W25Q128&#34;</span><span class=p>,</span> <span class=s>&#34;sspi10&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=n>RT_ERROR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>RT_EOK</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>INIT_COMPONENT_EXPORT</span><span class=p>(</span><span class=n>rt_soft_spi_flash_init</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>这里我们需要指定一个片选引脚，我暂时使用了<code>sspi2</code>的SCK引脚作为片选，这里注意不要同时打开<code>sspi1</code>和<code>sspi2</code>，后续我会专门上传一个通用GPIO作为片选引脚，到时候就不会产生问题了。然后软件spi设备的挂载使用的是<code>sspi1 bus</code>及<code>sspi10 device</code>，并且挂载flash设备到<code>sspi10</code>。</p><p>另外我们在<code>.\rt-thread\bsp\lpc55sxx\lpc55s69_nxp_evk\board\ports\</code>下新建<code>fal_sample.c</code>文件，并编写测试代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>//fal_sample.c
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Copyright (c) 2006-2023, RT-Thread Development Team
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * SPDX-License-Identifier: Apache-2.0
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * Change Logs:
</span></span></span><span class=line><span class=cl><span class=cm> * Date           Author       Notes
</span></span></span><span class=line><span class=cl><span class=cm> * 2023-04-21     Wangyuqiang  the first version
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;rtthread.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;rtdevice.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;board.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;fal.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define BUF_SIZE 1024
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>fal_test</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>partiton_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>,</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span> <span class=n>buf</span><span class=p>[</span><span class=n>BUF_SIZE</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=k>struct</span> <span class=n>fal_flash_dev</span> <span class=o>*</span><span class=n>flash_dev</span> <span class=o>=</span> <span class=n>RT_NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=k>struct</span> <span class=n>fal_partition</span> <span class=o>*</span><span class=n>partition</span> <span class=o>=</span> <span class=n>RT_NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>partiton_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Input param partition name is null!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>partition</span> <span class=o>=</span> <span class=nf>fal_partition_find</span><span class=p>(</span><span class=n>partiton_name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>partition</span> <span class=o>==</span> <span class=n>RT_NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Find partition (%s) failed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>partiton_name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>flash_dev</span> <span class=o>=</span> <span class=nf>fal_flash_device_find</span><span class=p>(</span><span class=n>partition</span><span class=o>-&gt;</span><span class=n>flash_name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>flash_dev</span> <span class=o>==</span> <span class=n>RT_NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Find flash device (%s) failed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>partition</span><span class=o>-&gt;</span><span class=n>flash_name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Flash device : %s   &#34;</span>
</span></span><span class=line><span class=cl>               <span class=s>&#34;Flash size : %dK   </span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>               <span class=s>&#34;Partition : %s   &#34;</span>
</span></span><span class=line><span class=cl>               <span class=s>&#34;Partition size: %dK</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                <span class=n>partition</span><span class=o>-&gt;</span><span class=n>flash_name</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                <span class=n>flash_dev</span><span class=o>-&gt;</span><span class=n>len</span><span class=o>/</span><span class=mi>1024</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>partition</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>partition</span><span class=o>-&gt;</span><span class=n>len</span><span class=o>/</span><span class=mi>1024</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* erase all partition */</span>
</span></span><span class=line><span class=cl>    <span class=n>ret</span> <span class=o>=</span> <span class=nf>fal_partition_erase_all</span><span class=p>(</span><span class=n>partition</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Partition (%s) erase failed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>partition</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Erase (%s) partition finish!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>partiton_name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* read the specified partition and check data */</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>partition</span><span class=o>-&gt;</span><span class=n>len</span><span class=p>;)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_memset</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=n>BUF_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>len</span> <span class=o>=</span> <span class=p>(</span><span class=n>partition</span><span class=o>-&gt;</span><span class=n>len</span> <span class=o>-</span> <span class=n>i</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>BUF_SIZE</span> <span class=o>?</span> <span class=nl>BUF_SIZE</span> <span class=p>:</span> <span class=p>(</span><span class=n>partition</span><span class=o>-&gt;</span><span class=n>len</span> <span class=o>-</span> <span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>=</span> <span class=nf>fal_partition_read</span><span class=p>(</span><span class=n>partition</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Partition (%s) read failed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>partition</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>ret</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span><span class=p>(</span><span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>len</span><span class=p>;</span> <span class=n>j</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>buf</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>!=</span> <span class=mh>0xFF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;The erase operation did not really succeed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>ret</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>i</span> <span class=o>+=</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* write 0x00 to the specified partition */</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>partition</span><span class=o>-&gt;</span><span class=n>len</span><span class=p>;)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_memset</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=n>BUF_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>len</span> <span class=o>=</span> <span class=p>(</span><span class=n>partition</span><span class=o>-&gt;</span><span class=n>len</span> <span class=o>-</span> <span class=n>i</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>BUF_SIZE</span> <span class=o>?</span> <span class=nl>BUF_SIZE</span> <span class=p>:</span> <span class=p>(</span><span class=n>partition</span><span class=o>-&gt;</span><span class=n>len</span> <span class=o>-</span> <span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>=</span> <span class=nf>fal_partition_write</span><span class=p>(</span><span class=n>partition</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Partition (%s) write failed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>partition</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>ret</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>i</span> <span class=o>+=</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Write (%s) partition finish! Write size %d(%dK).</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>partiton_name</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>i</span><span class=o>/</span><span class=mi>1024</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* read the specified partition and check data */</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>partition</span><span class=o>-&gt;</span><span class=n>len</span><span class=p>;)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_memset</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=mh>0xFF</span><span class=p>,</span> <span class=n>BUF_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>len</span> <span class=o>=</span> <span class=p>(</span><span class=n>partition</span><span class=o>-&gt;</span><span class=n>len</span> <span class=o>-</span> <span class=n>i</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>BUF_SIZE</span> <span class=o>?</span> <span class=nl>BUF_SIZE</span> <span class=p>:</span> <span class=p>(</span><span class=n>partition</span><span class=o>-&gt;</span><span class=n>len</span> <span class=o>-</span> <span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>=</span> <span class=nf>fal_partition_read</span><span class=p>(</span><span class=n>partition</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Partition (%s) read failed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>partition</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>ret</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span><span class=p>(</span><span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>len</span><span class=p>;</span> <span class=n>j</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>buf</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>!=</span> <span class=mh>0x00</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;The write operation did not really succeed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>ret</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>i</span> <span class=o>+=</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ret</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>fal_sample</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* 1- init */</span>
</span></span><span class=line><span class=cl>    <span class=nf>fal_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>fal_test</span><span class=p>(</span><span class=s>&#34;font&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Fal partition (%s) test success!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=s>&#34;font&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Fal partition (%s) test failed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=s>&#34;font&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>fal_test</span><span class=p>(</span><span class=s>&#34;download&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Fal partition (%s) test success!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=s>&#34;download&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Fal partition (%s) test failed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=s>&#34;download&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>MSH_CMD_EXPORT</span><span class=p>(</span><span class=n>fal_sample</span><span class=p>,</span> <span class=n>fal</span> <span class=n>sample</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=15-测试结果>1.5 测试结果</h3><p>到这里就可以进行编译下载了，成功后的截图如下：</p><p><img src=https://raw.githubusercontent.com/kurisaW/picbed/main/img2023/202304231728293.png loading=lazy alt=image-20230423172831146></p><h2 id=2dfs文件系统>2.DFS文件系统</h2><h3 id=21-什么是dfs>2.1 什么是DFS</h3><p>DFS 是 RT-Thread 提供的虚拟文件系统组件，全称为 Device File System，即设备虚拟文件系统，文件系统的名称使用类似 UNIX 文件、文件夹的风格，目录结构如下图所示：</p><p><img src=https://raw.githubusercontent.com/kurisaW/picbed/main/img2023/202304231733906.png loading=lazy alt=image-20230423173347702></p><p>在 RT-Thread DFS 中，文件系统有统一的根目录，使用 <code>/</code> 来表示。而在根目录下的 f1.bin 文件则使用 <code>/f1.bin</code> 来表示，2018 目录下的 <code>f1.bin</code> 目录则使用 <code>/data/2018/f1.bin</code> 来表示。即目录的分割符号是 <code>/</code>，这与 UNIX/Linux 完全相同，与 Windows 则不相同（Windows 操作系统上使用 <code>\</code> 来作为目录的分割符）。</p><h3 id=22-dfs架构>2.2 DFS架构</h3><p>RT-Thread DFS 组件的主要功能特点有：</p><ul><li>为应用程序提供统一的 POSIX 文件和目录操作接口：read、write、poll/select 等。</li><li>支持多种类型的文件系统，如 FatFS、RomFS、DevFS 等，并提供普通文件、设备文件、网络文件描述符的管理。</li><li>支持多种类型的存储设备，如 SD Card、SPI Flash、Nand Flash 等。</li></ul><p>DFS 的层次架构如下图所示，主要分为 POSIX 接口层、虚拟文件系统层和设备抽象层。</p><p><img src=https://raw.githubusercontent.com/kurisaW/picbed/main/img2023/202304231735074.png loading=lazy alt=image-20230423173515014></p><h3 id=23-使用env配置dfs>2.3 使用ENV配置DFS</h3><p>打开ENV，进入路径<code>RT-Thread Components → DFS: device virtual file system</code>，使能<code>[*] DFS: device virtual file system</code></p><p><img src=https://raw.githubusercontent.com/kurisaW/picbed/main/img2023/202304231741428.png loading=lazy alt=image-20230423174113310></p><p>由于DFS使用的是POSIX接口，而dfs_posix.h已经在新版本中被移除了，如果想要兼容老版本，可以在menuconfig中使能<code>RT-Thread Components->[*] Support legacy version for compatibility</code></p><p><img src=https://raw.githubusercontent.com/kurisaW/picbed/main/img2023/202304231808158.png loading=lazy alt=image-20230423180859035></p><p>由于elmfat文件系统默认最大扇区大小为512，但我们使用的flash模块<code>W25Q128</code>的Flash扇区大小为4096，为了将elmfat文件系统挂载到W25Q128上，这里的<code>Maximum sector size</code>需要和W25Q128扇区大小保持一致，修改为4096，路径：<code>RT-Thread Components → DFS: device virtual file system → [*] Enable elm-chan fatfs / elm-chan's FatFs, Generic FAT Filesystem Module</code></p><p><img src=https://raw.githubusercontent.com/kurisaW/picbed/main/img2023/202304231818347.png loading=lazy alt=image-20230423181825139></p><p>保存退出后使用<code>scons --target=mdk5</code>生成MDK5工程。</p><h3 id=24-dfs挂载到fal分区测试>2.4 DFS挂载到FAL分区测试</h3><p>这里增加FAL flash抽象层，我们将elmfat文件系统挂载到W25Q128 flash设备的filesystem分区上，由于FAL管理的filesystem分区不是块设备，需要先使用FAL分区转BLK设备接口函数将filesystem分区转换为块设备，然后再将DFS elmfat文件系统挂载到filesystem块设备上。</p><p>我们接着修改<code>fal_sample.c</code>文件，修改后代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Copyright (c) 2006-2023, RT-Thread Development Team
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * SPDX-License-Identifier: Apache-2.0
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * Change Logs:
</span></span></span><span class=line><span class=cl><span class=cm> * Date           Author       Notes
</span></span></span><span class=line><span class=cl><span class=cm> * 2023-04-21     Wangyuqiang  the first version
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;rtthread.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;rtdevice.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;board.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;fal.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;dfs_posix.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define FS_PARTITION_NAME  &#34;filesystem&#34;
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define BUF_SIZE 1024
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>fal_test</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>partiton_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>,</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span> <span class=n>buf</span><span class=p>[</span><span class=n>BUF_SIZE</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=k>struct</span> <span class=n>fal_flash_dev</span> <span class=o>*</span><span class=n>flash_dev</span> <span class=o>=</span> <span class=n>RT_NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=k>struct</span> <span class=n>fal_partition</span> <span class=o>*</span><span class=n>partition</span> <span class=o>=</span> <span class=n>RT_NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>partiton_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Input param partition name is null!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>partition</span> <span class=o>=</span> <span class=nf>fal_partition_find</span><span class=p>(</span><span class=n>partiton_name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>partition</span> <span class=o>==</span> <span class=n>RT_NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Find partition (%s) failed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>partiton_name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>flash_dev</span> <span class=o>=</span> <span class=nf>fal_flash_device_find</span><span class=p>(</span><span class=n>partition</span><span class=o>-&gt;</span><span class=n>flash_name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>flash_dev</span> <span class=o>==</span> <span class=n>RT_NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Find flash device (%s) failed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>partition</span><span class=o>-&gt;</span><span class=n>flash_name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Flash device : %s   &#34;</span>
</span></span><span class=line><span class=cl>               <span class=s>&#34;Flash size : %dK   </span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>               <span class=s>&#34;Partition : %s   &#34;</span>
</span></span><span class=line><span class=cl>               <span class=s>&#34;Partition size: %dK</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                <span class=n>partition</span><span class=o>-&gt;</span><span class=n>flash_name</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                <span class=n>flash_dev</span><span class=o>-&gt;</span><span class=n>len</span><span class=o>/</span><span class=mi>1024</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>partition</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>partition</span><span class=o>-&gt;</span><span class=n>len</span><span class=o>/</span><span class=mi>1024</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* erase all partition */</span>
</span></span><span class=line><span class=cl>    <span class=n>ret</span> <span class=o>=</span> <span class=nf>fal_partition_erase_all</span><span class=p>(</span><span class=n>partition</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Partition (%s) erase failed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>partition</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Erase (%s) partition finish!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>partiton_name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* read the specified partition and check data */</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>partition</span><span class=o>-&gt;</span><span class=n>len</span><span class=p>;)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_memset</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=n>BUF_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>len</span> <span class=o>=</span> <span class=p>(</span><span class=n>partition</span><span class=o>-&gt;</span><span class=n>len</span> <span class=o>-</span> <span class=n>i</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>BUF_SIZE</span> <span class=o>?</span> <span class=nl>BUF_SIZE</span> <span class=p>:</span> <span class=p>(</span><span class=n>partition</span><span class=o>-&gt;</span><span class=n>len</span> <span class=o>-</span> <span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>=</span> <span class=nf>fal_partition_read</span><span class=p>(</span><span class=n>partition</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Partition (%s) read failed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>partition</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>ret</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span><span class=p>(</span><span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>len</span><span class=p>;</span> <span class=n>j</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>buf</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>!=</span> <span class=mh>0xFF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;The erase operation did not really succeed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>ret</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>i</span> <span class=o>+=</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* write 0x00 to the specified partition */</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>partition</span><span class=o>-&gt;</span><span class=n>len</span><span class=p>;)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_memset</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=n>BUF_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>len</span> <span class=o>=</span> <span class=p>(</span><span class=n>partition</span><span class=o>-&gt;</span><span class=n>len</span> <span class=o>-</span> <span class=n>i</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>BUF_SIZE</span> <span class=o>?</span> <span class=nl>BUF_SIZE</span> <span class=p>:</span> <span class=p>(</span><span class=n>partition</span><span class=o>-&gt;</span><span class=n>len</span> <span class=o>-</span> <span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>=</span> <span class=nf>fal_partition_write</span><span class=p>(</span><span class=n>partition</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Partition (%s) write failed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>partition</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>ret</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>i</span> <span class=o>+=</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Write (%s) partition finish! Write size %d(%dK).</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>partiton_name</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>i</span><span class=o>/</span><span class=mi>1024</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* read the specified partition and check data */</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>partition</span><span class=o>-&gt;</span><span class=n>len</span><span class=p>;)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_memset</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=mh>0xFF</span><span class=p>,</span> <span class=n>BUF_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>len</span> <span class=o>=</span> <span class=p>(</span><span class=n>partition</span><span class=o>-&gt;</span><span class=n>len</span> <span class=o>-</span> <span class=n>i</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>BUF_SIZE</span> <span class=o>?</span> <span class=nl>BUF_SIZE</span> <span class=p>:</span> <span class=p>(</span><span class=n>partition</span><span class=o>-&gt;</span><span class=n>len</span> <span class=o>-</span> <span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>=</span> <span class=nf>fal_partition_read</span><span class=p>(</span><span class=n>partition</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Partition (%s) read failed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>partition</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>ret</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span><span class=p>(</span><span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>len</span><span class=p>;</span> <span class=n>j</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>buf</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>!=</span> <span class=mh>0x00</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;The write operation did not really succeed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>ret</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>i</span> <span class=o>+=</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ret</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>fal_sample</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* 1- init */</span>
</span></span><span class=line><span class=cl>    <span class=nf>fal_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>fal_test</span><span class=p>(</span><span class=s>&#34;font&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Fal partition (%s) test success!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=s>&#34;font&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Fal partition (%s) test failed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=s>&#34;font&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>fal_test</span><span class=p>(</span><span class=s>&#34;download&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Fal partition (%s) test success!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=s>&#34;download&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Fal partition (%s) test failed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=s>&#34;download&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>MSH_CMD_EXPORT</span><span class=p>(</span><span class=n>fal_sample</span><span class=p>,</span> <span class=n>fal</span> <span class=n>sample</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>fal_elmfat_sample</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>fd</span><span class=p>,</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>statfs</span> <span class=n>elm_stat</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>fal_blk_device</span> <span class=o>*</span><span class=n>blk_dev</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>str</span><span class=p>[]</span> <span class=o>=</span> <span class=s>&#34;elmfat mount to W25Q flash.&#34;</span><span class=p>,</span> <span class=n>buf</span><span class=p>[</span><span class=mi>80</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* fal init */</span>
</span></span><span class=line><span class=cl>    <span class=nf>fal_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* create block device */</span>
</span></span><span class=line><span class=cl>    <span class=n>blk_dev</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=n>fal_blk_device</span> <span class=o>*</span><span class=p>)</span><span class=nf>fal_blk_device_create</span><span class=p>(</span><span class=n>FS_PARTITION_NAME</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>blk_dev</span> <span class=o>==</span> <span class=n>RT_NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Can&#39;t create a block device on &#39;%s&#39; partition.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>FS_PARTITION_NAME</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Create a block device on the %s partition of flash successful.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>FS_PARTITION_NAME</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* make a elmfat format filesystem */</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nf>dfs_mkfs</span><span class=p>(</span><span class=s>&#34;elm&#34;</span><span class=p>,</span> <span class=n>FS_PARTITION_NAME</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;make elmfat filesystem success.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* mount elmfat file system to FS_PARTITION_NAME */</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nf>dfs_mount</span><span class=p>(</span><span class=n>FS_PARTITION_NAME</span><span class=p>,</span> <span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=s>&#34;elm&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;elmfat filesystem mount success.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* Get elmfat file system statistics */</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nf>statfs</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>elm_stat</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;elmfat filesystem block size: %d, total blocks: %d, free blocks: %d.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                    <span class=n>elm_stat</span><span class=p>.</span><span class=n>f_bsize</span><span class=p>,</span> <span class=n>elm_stat</span><span class=p>.</span><span class=n>f_blocks</span><span class=p>,</span> <span class=n>elm_stat</span><span class=p>.</span><span class=n>f_bfree</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nf>mkdir</span><span class=p>(</span><span class=s>&#34;/user&#34;</span><span class=p>,</span> <span class=mh>0x777</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;make a directory: &#39;/user&#39;.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Write string &#39;%s&#39; to /user/test.txt.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>str</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* Open the file in create and read-write mode, create the file if it does not exist*/</span>
</span></span><span class=line><span class=cl>    <span class=n>fd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=s>&#34;/user/test.txt&#34;</span><span class=p>,</span> <span class=n>O_WRONLY</span> <span class=o>|</span> <span class=n>O_CREAT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>fd</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nf>write</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>str</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>str</span><span class=p>))</span> <span class=o>==</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>str</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Write data done.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>   
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* Open file in read-only mode */</span>
</span></span><span class=line><span class=cl>    <span class=n>fd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=s>&#34;/user/test.txt&#34;</span><span class=p>,</span> <span class=n>O_RDONLY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>fd</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>size</span> <span class=o>=</span> <span class=nf>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>buf</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=n>size</span> <span class=o>==</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>str</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Read data from file test.txt(size: %d): %s </span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>size</span><span class=p>,</span> <span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>MSH_CMD_EXPORT_ALIAS</span><span class=p>(</span><span class=n>fal_elmfat_sample</span><span class=p>,</span> <span class=n>fal_elmfat</span><span class=p>,</span><span class=n>fal</span> <span class=n>elmfat</span> <span class=n>sample</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=25-测试结果>2.5 测试结果</h3><p>测试结果如下：</p><p><img src=https://raw.githubusercontent.com/kurisaW/picbed/main/img2023/202304231822040.png loading=lazy alt=image-20230423182204922></p><h2 id=3easyflash移植到fal分区>3.Easyflash移植到FAL分区</h2><h3 id=31-简述easyflash>3.1 简述EasyFlash</h3><p>关于EasyFlash的来源我们已经讲过了，此处不再赘述。<a class=link href="https://gitee.com/link?target=https%3A%2F%2Fgithub.com%2Farmink%2FEasyFlash" target=_blank rel=noopener>EasyFlash</a>是一款开源的轻量级嵌入式Flash存储器库，方便开发者更加轻松的实现基于Flash存储器的常见应用开发。非常适合智能家居、可穿戴、工控、医疗、物联网等需要断电存储功能的产品，资源占用极低，支持各种 MCU 片上存储器。</p><p>EasyFlash不仅能够实现对产品的 <strong>设定参数</strong> 或 <strong>运行日志</strong> 等信息的掉电保存功能，还封装了简洁的 <strong>增加、删除、修改及查询</strong> 方法， 降低了开发者对产品参数的处理难度，也保证了产品在后期升级时拥有更好的扩展性。让Flash变为NoSQL（非关系型数据库）模型的小型键值（Key-Value）存储数据库。</p><h3 id=32easyflash软件包使用>3.2EasyFlash软件包使用</h3><p>打开ENV进入路径：<code>RT-Thread online packages → tools packages → EasyFlash: Lightweight embedded flash memory library.</code>，选择软件包版本为最新版。</p><p><img src=https://raw.githubusercontent.com/kurisaW/picbed/main/img2023/202304231836146.png loading=lazy alt=image-20230423183612019></p><p>配置后退出ENV，同时使用<code>pkgs --update</code>下载软件包，然后再使用<code>scons --target=mdk5</code>重新生成MDK5文件</p><h3 id=33-移植easyflash>3.3 移植easyflash</h3><p>下载完easyflash软件包后，我们复制<code>.\rt-thread\bsp\lpc55sxx\lpc55s69_nxp_evk\packages\EasyFlash-latest\ports\ef_fal_port.c</code>到目录<code>.\rt-thread\bsp\lpc55sxx\lpc55s69_nxp_evk\board\ports\easyflash\ef_fal_port.c</code>，双击打开该文件，完成以下修改：</p><ul><li><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// 修改 FAL_EF_PART_NAME 为 easyflash
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define FAL_EF_PART_NAME               &#34;easyflash&#34;
</span></span></span></code></pre></td></tr></table></div></div></li><li><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// 修改环境变量内容为 {&#34;boot_times&#34;, &#34;0&#34;}，这里我们先只设置一个开机次数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=k>const</span> <span class=n>ef_env</span> <span class=n>default_env_set</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s>&#34;boot_times&#34;</span><span class=p>,</span> <span class=s>&#34;0&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><h3 id=34-编写easyflash测试用例>3.4 编写Easyflash测试用例</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Copyright (c) 2006-2023, RT-Thread Development Team
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * SPDX-License-Identifier: Apache-2.0
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * Change Logs:
</span></span></span><span class=line><span class=cl><span class=cm> * Date           Author       Notes
</span></span></span><span class=line><span class=cl><span class=cm> * 2023-04-21     Wangyuqiang  the first version
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;rtthread.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;rtdevice.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;board.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;fal.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;dfs_posix.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;easyflash.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define FS_PARTITION_NAME  &#34;filesystem&#34;
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define BUF_SIZE 1024
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>fal_test</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>partiton_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>,</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span> <span class=n>buf</span><span class=p>[</span><span class=n>BUF_SIZE</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=k>struct</span> <span class=n>fal_flash_dev</span> <span class=o>*</span><span class=n>flash_dev</span> <span class=o>=</span> <span class=n>RT_NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=k>struct</span> <span class=n>fal_partition</span> <span class=o>*</span><span class=n>partition</span> <span class=o>=</span> <span class=n>RT_NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>partiton_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Input param partition name is null!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>partition</span> <span class=o>=</span> <span class=nf>fal_partition_find</span><span class=p>(</span><span class=n>partiton_name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>partition</span> <span class=o>==</span> <span class=n>RT_NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Find partition (%s) failed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>partiton_name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>flash_dev</span> <span class=o>=</span> <span class=nf>fal_flash_device_find</span><span class=p>(</span><span class=n>partition</span><span class=o>-&gt;</span><span class=n>flash_name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>flash_dev</span> <span class=o>==</span> <span class=n>RT_NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Find flash device (%s) failed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>partition</span><span class=o>-&gt;</span><span class=n>flash_name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Flash device : %s   &#34;</span>
</span></span><span class=line><span class=cl>               <span class=s>&#34;Flash size : %dK   </span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>               <span class=s>&#34;Partition : %s   &#34;</span>
</span></span><span class=line><span class=cl>               <span class=s>&#34;Partition size: %dK</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                <span class=n>partition</span><span class=o>-&gt;</span><span class=n>flash_name</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                <span class=n>flash_dev</span><span class=o>-&gt;</span><span class=n>len</span><span class=o>/</span><span class=mi>1024</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>partition</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>partition</span><span class=o>-&gt;</span><span class=n>len</span><span class=o>/</span><span class=mi>1024</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* erase all partition */</span>
</span></span><span class=line><span class=cl>    <span class=n>ret</span> <span class=o>=</span> <span class=nf>fal_partition_erase_all</span><span class=p>(</span><span class=n>partition</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Partition (%s) erase failed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>partition</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Erase (%s) partition finish!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>partiton_name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* read the specified partition and check data */</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>partition</span><span class=o>-&gt;</span><span class=n>len</span><span class=p>;)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_memset</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=n>BUF_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>len</span> <span class=o>=</span> <span class=p>(</span><span class=n>partition</span><span class=o>-&gt;</span><span class=n>len</span> <span class=o>-</span> <span class=n>i</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>BUF_SIZE</span> <span class=o>?</span> <span class=nl>BUF_SIZE</span> <span class=p>:</span> <span class=p>(</span><span class=n>partition</span><span class=o>-&gt;</span><span class=n>len</span> <span class=o>-</span> <span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>=</span> <span class=nf>fal_partition_read</span><span class=p>(</span><span class=n>partition</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Partition (%s) read failed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>partition</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>ret</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span><span class=p>(</span><span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>len</span><span class=p>;</span> <span class=n>j</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>buf</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>!=</span> <span class=mh>0xFF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;The erase operation did not really succeed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>ret</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>i</span> <span class=o>+=</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* write 0x00 to the specified partition */</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>partition</span><span class=o>-&gt;</span><span class=n>len</span><span class=p>;)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_memset</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=n>BUF_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>len</span> <span class=o>=</span> <span class=p>(</span><span class=n>partition</span><span class=o>-&gt;</span><span class=n>len</span> <span class=o>-</span> <span class=n>i</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>BUF_SIZE</span> <span class=o>?</span> <span class=nl>BUF_SIZE</span> <span class=p>:</span> <span class=p>(</span><span class=n>partition</span><span class=o>-&gt;</span><span class=n>len</span> <span class=o>-</span> <span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>=</span> <span class=nf>fal_partition_write</span><span class=p>(</span><span class=n>partition</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Partition (%s) write failed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>partition</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>ret</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>i</span> <span class=o>+=</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Write (%s) partition finish! Write size %d(%dK).</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>partiton_name</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>i</span><span class=o>/</span><span class=mi>1024</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* read the specified partition and check data */</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>partition</span><span class=o>-&gt;</span><span class=n>len</span><span class=p>;)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_memset</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=mh>0xFF</span><span class=p>,</span> <span class=n>BUF_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>len</span> <span class=o>=</span> <span class=p>(</span><span class=n>partition</span><span class=o>-&gt;</span><span class=n>len</span> <span class=o>-</span> <span class=n>i</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>BUF_SIZE</span> <span class=o>?</span> <span class=nl>BUF_SIZE</span> <span class=p>:</span> <span class=p>(</span><span class=n>partition</span><span class=o>-&gt;</span><span class=n>len</span> <span class=o>-</span> <span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>=</span> <span class=nf>fal_partition_read</span><span class=p>(</span><span class=n>partition</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Partition (%s) read failed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>partition</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>ret</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span><span class=p>(</span><span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>len</span><span class=p>;</span> <span class=n>j</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>buf</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>!=</span> <span class=mh>0x00</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;The write operation did not really succeed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>ret</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>i</span> <span class=o>+=</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ret</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>fal_sample</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* 1- init */</span>
</span></span><span class=line><span class=cl>    <span class=nf>fal_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>fal_test</span><span class=p>(</span><span class=s>&#34;font&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Fal partition (%s) test success!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=s>&#34;font&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Fal partition (%s) test failed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=s>&#34;font&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>fal_test</span><span class=p>(</span><span class=s>&#34;download&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Fal partition (%s) test success!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=s>&#34;download&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Fal partition (%s) test failed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=s>&#34;download&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>MSH_CMD_EXPORT</span><span class=p>(</span><span class=n>fal_sample</span><span class=p>,</span> <span class=n>fal</span> <span class=n>sample</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>fal_elmfat_sample</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>fd</span><span class=p>,</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>statfs</span> <span class=n>elm_stat</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>fal_blk_device</span> <span class=o>*</span><span class=n>blk_dev</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>str</span><span class=p>[]</span> <span class=o>=</span> <span class=s>&#34;elmfat mount to W25Q flash.&#34;</span><span class=p>,</span> <span class=n>buf</span><span class=p>[</span><span class=mi>80</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* fal init */</span>
</span></span><span class=line><span class=cl>    <span class=nf>fal_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* create block device */</span>
</span></span><span class=line><span class=cl>    <span class=n>blk_dev</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=n>fal_blk_device</span> <span class=o>*</span><span class=p>)</span><span class=nf>fal_blk_device_create</span><span class=p>(</span><span class=n>FS_PARTITION_NAME</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>blk_dev</span> <span class=o>==</span> <span class=n>RT_NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Can&#39;t create a block device on &#39;%s&#39; partition.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>FS_PARTITION_NAME</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Create a block device on the %s partition of flash successful.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>FS_PARTITION_NAME</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* make a elmfat format filesystem */</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nf>dfs_mkfs</span><span class=p>(</span><span class=s>&#34;elm&#34;</span><span class=p>,</span> <span class=n>FS_PARTITION_NAME</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;make elmfat filesystem success.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* mount elmfat file system to FS_PARTITION_NAME */</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nf>dfs_mount</span><span class=p>(</span><span class=n>FS_PARTITION_NAME</span><span class=p>,</span> <span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=s>&#34;elm&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;elmfat filesystem mount success.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* Get elmfat file system statistics */</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nf>statfs</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>elm_stat</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;elmfat filesystem block size: %d, total blocks: %d, free blocks: %d.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                    <span class=n>elm_stat</span><span class=p>.</span><span class=n>f_bsize</span><span class=p>,</span> <span class=n>elm_stat</span><span class=p>.</span><span class=n>f_blocks</span><span class=p>,</span> <span class=n>elm_stat</span><span class=p>.</span><span class=n>f_bfree</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nf>mkdir</span><span class=p>(</span><span class=s>&#34;/user&#34;</span><span class=p>,</span> <span class=mh>0x777</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;make a directory: &#39;/user&#39;.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Write string &#39;%s&#39; to /user/test.txt.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>str</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* Open the file in create and read-write mode, create the file if it does not exist*/</span>
</span></span><span class=line><span class=cl>    <span class=n>fd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=s>&#34;/user/test.txt&#34;</span><span class=p>,</span> <span class=n>O_WRONLY</span> <span class=o>|</span> <span class=n>O_CREAT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>fd</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nf>write</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>str</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>str</span><span class=p>))</span> <span class=o>==</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>str</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Write data done.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>   
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* Open file in read-only mode */</span>
</span></span><span class=line><span class=cl>    <span class=n>fd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=s>&#34;/user/test.txt&#34;</span><span class=p>,</span> <span class=n>O_RDONLY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>fd</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>size</span> <span class=o>=</span> <span class=nf>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>buf</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=n>size</span> <span class=o>==</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>str</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;Read data from file test.txt(size: %d): %s </span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>size</span><span class=p>,</span> <span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>MSH_CMD_EXPORT_ALIAS</span><span class=p>(</span><span class=n>fal_elmfat_sample</span><span class=p>,</span> <span class=n>fal_elmfat</span><span class=p>,</span><span class=n>fal</span> <span class=n>elmfat</span> <span class=n>sample</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>easyflash_sample</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* fal init */</span>
</span></span><span class=line><span class=cl>    <span class=nf>fal_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* easyflash init */</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nf>easyflash_init</span><span class=p>()</span> <span class=o>==</span> <span class=n>EF_NO_ERR</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>uint32_t</span> <span class=n>i_boot_times</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>char</span> <span class=o>*</span><span class=n>c_old_boot_times</span><span class=p>,</span> <span class=n>c_new_boot_times</span><span class=p>[</span><span class=mi>11</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/* get the boot count number from Env */</span>
</span></span><span class=line><span class=cl>        <span class=n>c_old_boot_times</span> <span class=o>=</span> <span class=nf>ef_get_env</span><span class=p>(</span><span class=s>&#34;boot_times&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=cm>/* get the boot count number failed */</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>c_old_boot_times</span> <span class=o>==</span> <span class=n>RT_NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>c_old_boot_times</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>i_boot_times</span> <span class=o>=</span> <span class=nf>atol</span><span class=p>(</span><span class=n>c_old_boot_times</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=cm>/* boot count +1 */</span>
</span></span><span class=line><span class=cl>        <span class=n>i_boot_times</span> <span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;===============================================</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;The system now boot %d times</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>i_boot_times</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>rt_kprintf</span><span class=p>(</span><span class=s>&#34;===============================================</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=cm>/* interger to string */</span>
</span></span><span class=line><span class=cl>        <span class=nf>sprintf</span><span class=p>(</span><span class=n>c_new_boot_times</span><span class=p>,</span> <span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=n>i_boot_times</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=cm>/* set and store the boot count number to Env */</span>
</span></span><span class=line><span class=cl>        <span class=nf>ef_set_env</span><span class=p>(</span><span class=s>&#34;boot_times&#34;</span><span class=p>,</span> <span class=n>c_new_boot_times</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>ef_save_env</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>MSH_CMD_EXPORT</span><span class=p>(</span><span class=n>easyflash_sample</span><span class=p>,</span> <span class=n>easyflash</span> <span class=n>sample</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=35-测试结果>3.5 测试结果</h3><p>打开串口助手，输入命令：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>msh</span> <span class=o>/&gt;</span><span class=n>easyflash_sample</span>
</span></span></code></pre></td></tr></table></div></div><p>第一次命令调用：</p><p><img src=https://raw.githubusercontent.com/kurisaW/picbed/main/img2023/202304231856640.png loading=lazy alt=image-20230423185619472></p><p>第二次RESET开发板后调用：</p><p><img src=https://raw.githubusercontent.com/kurisaW/picbed/main/img2023/202304231857243.png loading=lazy alt=image-20230423185703046></p><h2 id=4结语>4.结语</h2><p>至此本博客就到此结束，经历从移植软件模拟spi框架到LPC55S69，到移植过程中遇到不断的问题，到最后解决所有问题并提供应用示例，完成开发日记、开发笔记及应用教学，这个过程确实使我受益良多，其中感受最深的就是当然也更加感谢的是一些前辈们的指点迷津和博文记录，就目前国内嵌入式这个领域，相关开发经验相比较其他计算机行业确实有些不够包容和开放，也希望未来的朋友们能够怀揣着一颗求知及授学之心，共同建设好这个领域！</p><h2 id=5联系>5.联系</h2><ul><li><a class=link href=mailto:yifang.wangyq@foxmail.com>Email :yifang.wangyq@foxmail.com</a></li><li><a class=link href=https://github.com/kurisaW target=_blank rel=noopener>Github Address :https://github.com/kurisaW</a></li><li><a class=link href=https://kurisaw.github.io/ target=_blank rel=noopener>My Website :https://kurisaw.github.io</a></li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/nxp/>NXP</a>
<a href=/tags/lpc55s69/>LPC55s69</a>
<a href=/tags/lpc/>LPC</a>
<a href=/tags/fal/>FAL</a>
<a href=/tags/sfud/>SFUD</a>
<a href=/tags/easyflash/>Easyflash</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>Last updated on Apr 23, 2023 00:00 UTC</span></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})</script></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/nxplpc55s69-micropython%E7%A7%BB%E6%A4%8D%E6%97%A5%E5%BF%97/><div class=article-image><img src=/p/nxplpc55s69-micropython%E7%A7%BB%E6%A4%8D%E6%97%A5%E5%BF%97/cover.8a576ed4e34311bdaab96c9c7dbbfc89_hu1d41c96ada7dcbd0b71542fef1eff150_4218_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post 【NXP】LPC55S69-Micropython移植日志" data-key=【NXP】LPC55S69-Micropython移植日志 data-hash="md5-ildu1ONDEb2quWycfbv8iQ=="></div><div class=article-details><h2 class=article-title>【NXP】LPC55S69-Micropython移植日志</h2></div></a></article><article class=has-image><a href=/p/nxplpc55s69%E5%88%9D%E4%B8%8A%E6%89%8B/><div class=article-image><img src=/p/nxplpc55s69%E5%88%9D%E4%B8%8A%E6%89%8B/cover.89fd4331b6d80ee0bfb4d6ca368a09f3_hu31f054e617ccf5275f397086d95972c2_413191_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post 【NXP】LPC55S69初上手" data-key=【NXP】LPC55S69初上手 data-hash="md5-if1DMbbYDuC/tNbKNooJ8w=="></div><div class=article-details><h2 class=article-title>【NXP】LPC55S69初上手</h2></div></a></article><article class=has-image><a href=/p/nxplpc55s69%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/><div class=article-image><img src=/p/nxplpc55s69%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/cover.e0e66e26d71581d2a372ce183b076548_hu63ed3deabe1b375a8669082d0efcf2de_379910_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post 【NXP】LPC55S69开发环境搭建" data-key=【NXP】LPC55S69开发环境搭建 data-hash="md5-4OZuJtcVgdKjcs4YOwdlSA=="></div><div class=article-details><h2 class=article-title>【NXP】LPC55S69开发环境搭建</h2></div></a></article></div></div></aside><script src=https://giscus.app/client.js data-repo=kurisaW/Gitalk data-repo-id=R_kgDOI7omFg data-category=General data-category-id=DIC_kwDOI7omFs4CUI55 data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light_high_contrast data-lang=en crossorigin=anonymous async></script><script>function setGiscusTheme(e){let t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}(function(){addEventListener("message",t=>{if(event.origin!=="https://giscus.app")return;e()}),window.addEventListener("onColorSchemeChange",e);function e(){setGiscusTheme(document.documentElement.dataset.scheme==="light"?"light_high_contrast":"dark_high_contrast")}})()</script><footer class=site-footer><section class=copyright>&copy;
2021 -
2024 kurisaW</section><section class=powerby>顺颂时祺，秋绥冬禧<br>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.26.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>